# ä¸Šä¸‹æ–‡ç®¡ç† - ç¤ºä¾‹ä»£ç 

## ğŸ“ åŸºç¡€ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæ„å»ºå’ŒæŸ¥çœ‹ä¸Šä¸‹æ–‡

```csharp
// æ¨¡æ‹Ÿä¸€ä¸ªå¯¹è¯ä¼šè¯
var messages = new List<ChatMessage>
{
    new ChatMessage 
    { 
        Role = "user", 
        Content = "è¯·å¸®æˆ‘åˆ›å»ºä¸€ä¸ª React ç»„ä»¶" 
    },
    new ChatMessage 
    { 
        Role = "assistant", 
        Content = @"å¥½çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„ React ç»„ä»¶ï¼š

```tsx
import React from 'react';

interface ButtonProps {
  label: string;
  onClick: () => void;
}

export const Button: React.FC<ButtonProps> = ({ label, onClick }) => {
  return <button onClick={onClick}>{label}</button>;
};
```

è¿™ä¸ªç»„ä»¶æ¥å— label å’Œ onClick ä¸¤ä¸ªå±æ€§ã€‚"
    },
    new ChatMessage 
    { 
        Role = "user", 
        Content = "è¯·æ·»åŠ æ ·å¼" 
    }
};

// æ„å»ºä¸Šä¸‹æ–‡
var contextItems = await ContextManagerService.BuildContextFromMessagesAsync(
    sessionId, 
    messages
);

// æŸ¥çœ‹ç»Ÿè®¡
var stats = ContextManagerService.GetContextStatistics(sessionId);
Console.WriteLine($"ä¸Šä¸‹æ–‡é¡¹æ•°é‡: {stats.ItemCount}");
Console.WriteLine($"Token ä½¿ç”¨: {stats.UsedTokens} / {stats.TotalTokens}");
Console.WriteLine($"ä½¿ç”¨ç‡: {stats.UsagePercentage:F1}%");

// è¾“å‡ºï¼š
// ä¸Šä¸‹æ–‡é¡¹æ•°é‡: 4
// - 3 æ¡æ¶ˆæ¯
// - 1 ä¸ªä»£ç ç‰‡æ®µï¼ˆè‡ªåŠ¨æå–ï¼‰
// Token ä½¿ç”¨: 2,450 / 100,000
// ä½¿ç”¨ç‡: 2.5%
```

### ç¤ºä¾‹ 2ï¼šæ‰‹åŠ¨ç®¡ç†ä¸Šä¸‹æ–‡é¡¹

```csharp
// è·å–æ‰€æœ‰ä¸Šä¸‹æ–‡é¡¹
var items = ContextManagerService.GetContextItems(sessionId);

// æ‰¾åˆ°ä»£ç ç‰‡æ®µ
var codeSnippet = items.FirstOrDefault(i => i.Type == ContextItemType.CodeSnippet);
if (codeSnippet != null)
{
    // æé«˜ä¼˜å…ˆçº§
    ContextManagerService.UpdateContextItemPriority(sessionId, codeSnippet.Id, 9);
    Console.WriteLine($"å·²å°†ä»£ç ç‰‡æ®µä¼˜å…ˆçº§æå‡åˆ° 9");
    
    // æ·»åŠ æ ‡ç­¾
    codeSnippet.Tags.Add("react");
    codeSnippet.Tags.Add("component");
}

// æ’é™¤ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
var firstUserMessage = items.FirstOrDefault(i => i.Type == ContextItemType.UserMessage);
if (firstUserMessage != null)
{
    ContextManagerService.ToggleContextItem(sessionId, firstUserMessage.Id);
    Console.WriteLine($"å·²æ’é™¤æ¶ˆæ¯: {firstUserMessage.Content}");
}
```

### ç¤ºä¾‹ 3ï¼šæœç´¢å’Œç­›é€‰

```csharp
// æœç´¢åŒ…å« "React" çš„ä¸Šä¸‹æ–‡é¡¹
var reactItems = ContextManagerService.SearchContextItems(sessionId, "React");
Console.WriteLine($"æ‰¾åˆ° {reactItems.Count} ä¸ªåŒ…å« 'React' çš„é¡¹");

// åªè·å–ä»£ç ç‰‡æ®µ
var codeSnippets = ContextManagerService.FilterContextItemsByType(
    sessionId, 
    ContextItemType.CodeSnippet
);
Console.WriteLine($"å…±æœ‰ {codeSnippets.Count} ä¸ªä»£ç ç‰‡æ®µ");

// æŒ‰æ ‡ç­¾ç­›é€‰
var reactComponents = ContextManagerService.FilterContextItemsByTag(sessionId, "react");
Console.WriteLine($"æ‰¾åˆ° {reactComponents.Count} ä¸ª React ç›¸å…³é¡¹");
```

## ğŸ—œï¸ å‹ç¼©ç¤ºä¾‹

### ç¤ºä¾‹ 4ï¼šæ™ºèƒ½å‹ç¼©

```csharp
// æ¨¡æ‹Ÿé•¿å¯¹è¯ï¼ˆ50 æ¡æ¶ˆæ¯ï¼‰
var longConversation = new List<ChatMessage>();
for (int i = 0; i < 50; i++)
{
    longConversation.Add(new ChatMessage 
    { 
        Role = i % 2 == 0 ? "user" : "assistant",
        Content = $"è¿™æ˜¯ç¬¬ {i + 1} æ¡æ¶ˆæ¯ï¼ŒåŒ…å«ä¸€äº›å†…å®¹..." + new string('x', 100)
    });
}

// æ„å»ºä¸Šä¸‹æ–‡
await ContextManagerService.BuildContextFromMessagesAsync(sessionId, longConversation);

// æŸ¥çœ‹å‹ç¼©å‰çš„çŠ¶æ€
var statsBefore = ContextManagerService.GetContextStatistics(sessionId);
Console.WriteLine($"å‹ç¼©å‰:");
Console.WriteLine($"  Token ä½¿ç”¨: {statsBefore.UsedTokens:N0}");
Console.WriteLine($"  ä½¿ç”¨ç‡: {statsBefore.UsagePercentage:F1}%");

// æ‰§è¡Œæ™ºèƒ½å‹ç¼©
var result = await ContextManagerService.CompressContextAsync(
    sessionId, 
    CompressionStrategy.SmartSummary
);

// æŸ¥çœ‹å‹ç¼©ç»“æœ
var statsAfter = ContextManagerService.GetContextStatistics(sessionId);
Console.WriteLine($"\nå‹ç¼©å:");
Console.WriteLine($"  Token ä½¿ç”¨: {statsAfter.UsedTokens:N0}");
Console.WriteLine($"  ä½¿ç”¨ç‡: {statsAfter.UsagePercentage:F1}%");
Console.WriteLine($"  èŠ‚çœ: {result.TokensSaved:N0} tokens ({result.CompressionRatio:F1}%)");
Console.WriteLine($"  ç§»é™¤é¡¹æ•°: {result.RemovedItems.Count}");
Console.WriteLine($"  å‹ç¼©é¡¹æ•°: {result.CompressedItems.Count}");

// è¾“å‡ºç¤ºä¾‹ï¼š
// å‹ç¼©å‰:
//   Token ä½¿ç”¨: 85,000
//   ä½¿ç”¨ç‡: 85.0%
//
// å‹ç¼©å:
//   Token ä½¿ç”¨: 55,000
//   ä½¿ç”¨ç‡: 55.0%
//   èŠ‚çœ: 30,000 tokens (35.3%)
//   ç§»é™¤é¡¹æ•°: 15
//   å‹ç¼©é¡¹æ•°: 10
```

### ç¤ºä¾‹ 5ï¼šå¯¹æ¯”ä¸åŒå‹ç¼©ç­–ç•¥

```csharp
// å‡†å¤‡æµ‹è¯•æ•°æ®
var testMessages = GenerateTestMessages(100); // ç”Ÿæˆ 100 æ¡æµ‹è¯•æ¶ˆæ¯

// æµ‹è¯•æ¯ç§ç­–ç•¥
var strategies = new[] 
{
    CompressionStrategy.KeepRecent,
    CompressionStrategy.KeepHighPriority,
    CompressionStrategy.SmartSummary,
    CompressionStrategy.RemoveDuplicates
};

foreach (var strategy in strategies)
{
    // é‡æ–°æ„å»ºä¸Šä¸‹æ–‡
    await ContextManagerService.BuildContextFromMessagesAsync(sessionId, testMessages);
    
    // å‹ç¼©
    var result = await ContextManagerService.CompressContextAsync(sessionId, strategy);
    
    // è¾“å‡ºç»“æœ
    Console.WriteLine($"\nç­–ç•¥: {strategy}");
    Console.WriteLine($"  èŠ‚çœ: {result.TokensSaved:N0} tokens");
    Console.WriteLine($"  å‹ç¼©ç‡: {result.CompressionRatio:F1}%");
    Console.WriteLine($"  ç§»é™¤é¡¹: {result.RemovedItems.Count}");
}

// è¾“å‡ºç¤ºä¾‹ï¼š
// ç­–ç•¥: KeepRecent
//   èŠ‚çœ: 75,000 tokens
//   å‹ç¼©ç‡: 75.0%
//   ç§»é™¤é¡¹: 90
//
// ç­–ç•¥: KeepHighPriority
//   èŠ‚çœ: 45,000 tokens
//   å‹ç¼©ç‡: 45.0%
//   ç§»é™¤é¡¹: 55
//
// ç­–ç•¥: SmartSummary
//   èŠ‚çœ: 55,000 tokens
//   å‹ç¼©ç‡: 55.0%
//   ç§»é™¤é¡¹: 40
//
// ç­–ç•¥: RemoveDuplicates
//   èŠ‚çœ: 15,000 tokens
//   å‹ç¼©ç‡: 15.0%
//   ç§»é™¤é¡¹: 20
```

## ğŸ“ å·¥ä½œåŒºæ–‡ä»¶ç¤ºä¾‹

### ç¤ºä¾‹ 6ï¼šæ·»åŠ å·¥ä½œåŒºæ–‡ä»¶åˆ°ä¸Šä¸‹æ–‡

```csharp
// æ·»åŠ å•ä¸ªæ–‡ä»¶
await ContextManagerService.AddWorkspaceFileToContextAsync(
    sessionId,
    "src/components/Button.tsx"
);

// æ‰¹é‡æ·»åŠ æ–‡ä»¶
var filesToAdd = new List<string>
{
    "package.json",
    "tsconfig.json",
    "README.md",
    "src/App.tsx",
    "src/utils/helpers.ts"
};

await ContextManagerService.AddWorkspaceFilesToContextAsync(sessionId, filesToAdd);

// æŸ¥çœ‹æ·»åŠ çš„æ–‡ä»¶
var workspaceFiles = ContextManagerService.FilterContextItemsByType(
    sessionId,
    ContextItemType.WorkspaceFile
);

Console.WriteLine($"å·²æ·»åŠ  {workspaceFiles.Count} ä¸ªå·¥ä½œåŒºæ–‡ä»¶:");
foreach (var file in workspaceFiles)
{
    Console.WriteLine($"  - {file.FilePath} ({file.EstimatedTokens} tokens)");
}

// è¾“å‡ºï¼š
// å·²æ·»åŠ  5 ä¸ªå·¥ä½œåŒºæ–‡ä»¶:
//   - package.json (450 tokens)
//   - tsconfig.json (320 tokens)
//   - README.md (1,200 tokens)
//   - src/App.tsx (850 tokens)
//   - src/utils/helpers.ts (620 tokens)
```

### ç¤ºä¾‹ 7ï¼šè‡ªåŠ¨æå–æ–‡ä»¶å¼•ç”¨

```csharp
var message = new ChatMessage
{
    Role = "user",
    Content = @"è¯·æŸ¥çœ‹ä»¥ä¸‹æ–‡ä»¶ï¼š
    - src/components/Button.tsx:10-20
    - src/utils/api.ts:45
    - README.md
    
    å¹¶å¸®æˆ‘ä¼˜åŒ–ä»£ç ã€‚"
};

// æ„å»ºä¸Šä¸‹æ–‡ï¼ˆä¼šè‡ªåŠ¨æå–æ–‡ä»¶å¼•ç”¨ï¼‰
await ContextManagerService.BuildContextFromMessagesAsync(
    sessionId,
    new List<ChatMessage> { message }
);

// æŸ¥çœ‹æå–çš„æ–‡ä»¶å¼•ç”¨
var fileRefs = ContextManagerService.FilterContextItemsByType(
    sessionId,
    ContextItemType.FileReference
);

Console.WriteLine($"è‡ªåŠ¨æå–äº† {fileRefs.Count} ä¸ªæ–‡ä»¶å¼•ç”¨:");
foreach (var fileRef in fileRefs)
{
    Console.WriteLine($"  - {fileRef.FilePath}");
    if (fileRef.LineRange.HasValue)
    {
        Console.WriteLine($"    è¡Œå·: {fileRef.LineRange.Value.Start}-{fileRef.LineRange.Value.End}");
    }
}

// è¾“å‡ºï¼š
// è‡ªåŠ¨æå–äº† 3 ä¸ªæ–‡ä»¶å¼•ç”¨:
//   - src/components/Button.tsx
//     è¡Œå·: 10-20
//   - src/utils/api.ts
//     è¡Œå·: 45-45
//   - README.md
```

## ğŸ“¤ å¯¼å‡º/å¯¼å…¥ç¤ºä¾‹

### ç¤ºä¾‹ 8ï¼šå¯¼å‡ºä¸Šä¸‹æ–‡

```csharp
// å¯¼å‡ºä¸º JSON
var json = await ContextManagerService.ExportContextAsync(sessionId);

// ä¿å­˜åˆ°æ–‡ä»¶
await File.WriteAllTextAsync("context-backup.json", json);

Console.WriteLine("ä¸Šä¸‹æ–‡å·²å¯¼å‡ºåˆ° context-backup.json");

// æŸ¥çœ‹å¯¼å‡ºçš„æ•°æ®ç»“æ„
var exportData = JsonSerializer.Deserialize<Dictionary<string, JsonElement>>(json);
Console.WriteLine($"ä¼šè¯ ID: {exportData["SessionId"]}");
Console.WriteLine($"å¯¼å‡ºæ—¶é—´: {exportData["ExportedAt"]}");
Console.WriteLine($"ä¸Šä¸‹æ–‡é¡¹æ•°: {exportData["Items"].GetArrayLength()}");
```

### ç¤ºä¾‹ 9ï¼šå¯¼å…¥ä¸Šä¸‹æ–‡

```csharp
// ä»æ–‡ä»¶è¯»å–
var json = await File.ReadAllTextAsync("context-backup.json");

// å¯¼å…¥åˆ°æ–°ä¼šè¯
var newSessionId = Guid.NewGuid().ToString();
await ContextManagerService.ImportContextAsync(newSessionId, json);

// éªŒè¯å¯¼å…¥
var items = ContextManagerService.GetContextItems(newSessionId);
Console.WriteLine($"å·²å¯¼å…¥ {items.Count} ä¸ªä¸Šä¸‹æ–‡é¡¹");
```

## ğŸ¨ è‡ªå®šä¹‰ä¸Šä¸‹æ–‡é¡¹ç¤ºä¾‹

### ç¤ºä¾‹ 10ï¼šåˆ›å»ºè‡ªå®šä¹‰ä¸Šä¸‹æ–‡é¡¹

```csharp
// åˆ›å»ºä¸€ä¸ªåŒ…å«é¡¹ç›®éœ€æ±‚çš„ä¸Šä¸‹æ–‡é¡¹
var requirementItem = new ContextItem
{
    Type = ContextItemType.UserMessage,
    Content = @"é¡¹ç›®éœ€æ±‚ï¼š
    1. åˆ›å»ºä¸€ä¸ªç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
    2. æ”¯æŒ CRUD æ“ä½œ
    3. ä½¿ç”¨ React + TypeScript
    4. é›†æˆ Ant Design",
    Priority = 10, // æœ€é«˜ä¼˜å…ˆçº§
    Tags = new List<string> { "requirement", "important", "project-spec" },
    Summary = "ç”¨æˆ·ç®¡ç†ç³»ç»Ÿéœ€æ±‚æ–‡æ¡£"
};

ContextManagerService.AddContextItem(sessionId, requirementItem);

// åˆ›å»ºä¸€ä¸ªåŒ…å«æŠ€æœ¯æ ˆä¿¡æ¯çš„ä¸Šä¸‹æ–‡é¡¹
var techStackItem = new ContextItem
{
    Type = ContextItemType.CodeSnippet,
    Content = @"{
  ""frontend"": ""React 18 + TypeScript"",
  ""ui"": ""Ant Design 5"",
  ""state"": ""Redux Toolkit"",
  ""backend"": ""Node.js + Express"",
  ""database"": ""PostgreSQL""
}",
    Language = "json",
    Priority = 9,
    Tags = new List<string> { "tech-stack", "config" },
    Summary = "é¡¹ç›®æŠ€æœ¯æ ˆé…ç½®"
};

ContextManagerService.AddContextItem(sessionId, techStackItem);

// åˆ›å»ºä¸€ä¸ªåŒ…å« API æ–‡æ¡£çš„ä¸Šä¸‹æ–‡é¡¹
var apiDocItem = new ContextItem
{
    Type = ContextItemType.FileReference,
    Content = "API æ–‡æ¡£: https://api.example.com/docs",
    FilePath = "docs/api.md",
    Priority = 7,
    Tags = new List<string> { "api", "documentation" },
    Summary = "API æ¥å£æ–‡æ¡£"
};

ContextManagerService.AddContextItem(sessionId, apiDocItem);

Console.WriteLine("å·²æ·»åŠ  3 ä¸ªè‡ªå®šä¹‰ä¸Šä¸‹æ–‡é¡¹");
```

## ğŸ“Š ç»Ÿè®¡å’Œåˆ†æç¤ºä¾‹

### ç¤ºä¾‹ 11ï¼šç”Ÿæˆä¸Šä¸‹æ–‡æ‘˜è¦

```csharp
// ç”Ÿæˆæ‘˜è¦
var summary = await ContextManagerService.GenerateContextSummaryAsync(sessionId);

Console.WriteLine(summary);

// è¾“å‡ºç¤ºä¾‹ï¼š
// # ä¸Šä¸‹æ–‡æ‘˜è¦
//
// - æ€»é¡¹æ•°: 45
// - åŒ…å«é¡¹æ•°: 38
// - Token ä½¿ç”¨: 65,420 / 100,000 (65.4%)
//
// ## æŒ‰ç±»å‹åˆ†ç»„:
// - ç”¨æˆ·æ¶ˆæ¯: 15
// - åŠ©æ‰‹æ¶ˆæ¯: 15
// - ä»£ç ç‰‡æ®µ: 8
// - æ–‡ä»¶å¼•ç”¨: 5
// - å·¥ä½œåŒºæ–‡ä»¶: 2
//
// ## é«˜ä¼˜å…ˆçº§é¡¹:
// - [ç”¨æˆ·æ¶ˆæ¯] é¡¹ç›®éœ€æ±‚ï¼šåˆ›å»ºä¸€ä¸ªç”¨æˆ·ç®¡ç†ç³»ç»Ÿ... (ä¼˜å…ˆçº§: 10)
// - [ä»£ç ç‰‡æ®µ] [json] { "frontend": "React 18 + TypeScript"... (ä¼˜å…ˆçº§: 9)
// - [ä»£ç ç‰‡æ®µ] [tsx] import React from 'react';... (ä¼˜å…ˆçº§: 9)
// ...
```

### ç¤ºä¾‹ 12ï¼šç›‘æ§ Token ä½¿ç”¨

```csharp
// å®šæœŸæ£€æŸ¥ Token ä½¿ç”¨æƒ…å†µ
var timer = new System.Threading.Timer(async _ =>
{
    var stats = ContextManagerService.GetContextStatistics(sessionId);
    
    Console.WriteLine($"[{DateTime.Now:HH:mm:ss}] Token ä½¿ç”¨: {stats.UsagePercentage:F1}%");
    
    // å¦‚æœä½¿ç”¨ç‡è¶…è¿‡ 85%ï¼Œå‘å‡ºè­¦å‘Š
    if (stats.UsagePercentage > 85)
    {
        Console.WriteLine("âš ï¸ è­¦å‘Š: Token ä½¿ç”¨ç‡è¿‡é«˜ï¼Œå»ºè®®å‹ç¼©ä¸Šä¸‹æ–‡");
        
        // è‡ªåŠ¨å‹ç¼©
        var result = await ContextManagerService.AutoCompressIfNeededAsync(sessionId);
        if (result != null)
        {
            Console.WriteLine($"âœ… å·²è‡ªåŠ¨å‹ç¼©ï¼ŒèŠ‚çœ {result.TokensSaved:N0} tokens");
        }
    }
}, null, TimeSpan.Zero, TimeSpan.FromMinutes(5));

// è¾“å‡ºç¤ºä¾‹ï¼š
// [14:30:00] Token ä½¿ç”¨: 45.2%
// [14:35:00] Token ä½¿ç”¨: 67.8%
// [14:40:00] Token ä½¿ç”¨: 88.5%
// âš ï¸ è­¦å‘Š: Token ä½¿ç”¨ç‡è¿‡é«˜ï¼Œå»ºè®®å‹ç¼©ä¸Šä¸‹æ–‡
// âœ… å·²è‡ªåŠ¨å‹ç¼©ï¼ŒèŠ‚çœ 25,000 tokens
// [14:45:00] Token ä½¿ç”¨: 58.3%
```

## ğŸ§ª æµ‹è¯•è¾…åŠ©å‡½æ•°

```csharp
// ç”Ÿæˆæµ‹è¯•æ¶ˆæ¯
private List<ChatMessage> GenerateTestMessages(int count)
{
    var messages = new List<ChatMessage>();
    var random = new Random();
    
    for (int i = 0; i < count; i++)
    {
        var isUser = i % 2 == 0;
        var message = new ChatMessage
        {
            Role = isUser ? "user" : "assistant",
            Content = GenerateRandomContent(isUser, random),
            CreatedAt = DateTime.Now.AddMinutes(-count + i)
        };
        
        messages.Add(message);
    }
    
    return messages;
}

private string GenerateRandomContent(bool isUser, Random random)
{
    if (isUser)
    {
        var questions = new[]
        {
            "è¯·å¸®æˆ‘åˆ›å»ºä¸€ä¸ªç»„ä»¶",
            "å¦‚ä½•ä¼˜åŒ–è¿™æ®µä»£ç ï¼Ÿ",
            "è¿™ä¸ªé”™è¯¯æ€ä¹ˆè§£å†³ï¼Ÿ",
            "è¯·æ·»åŠ å•å…ƒæµ‹è¯•",
            "èƒ½å¦é‡æ„è¿™ä¸ªå‡½æ•°ï¼Ÿ"
        };
        return questions[random.Next(questions.Length)];
    }
    else
    {
        var hasCode = random.Next(3) == 0;
        var response = "å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ ã€‚" + new string(' ', random.Next(50, 200));
        
        if (hasCode)
        {
            response += $"\n\n```typescript\nfunction example() {{\n  // ç¤ºä¾‹ä»£ç \n  return 'Hello';\n}}\n```";
        }
        
        return response;
    }
}
```

---

**æç¤ºï¼š** è¿™äº›ç¤ºä¾‹å¯ä»¥ç›´æ¥åœ¨æ‚¨çš„é¡¹ç›®ä¸­ä½¿ç”¨ã€‚æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´å‚æ•°å’Œé€»è¾‘ã€‚

