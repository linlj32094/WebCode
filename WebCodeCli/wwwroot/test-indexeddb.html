<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB 存储测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">IndexedDB 存储测试</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">测试操作</h2>
            
            <div class="space-y-4">
                <button onclick="testSaveSession()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    保存测试会话
                </button>
                
                <button onclick="testLoadSessions()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                    加载所有会话
                </button>
                
                <button onclick="testGetSession()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                    获取单个会话
                </button>
                
                <button onclick="testDeleteSession()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                    删除测试会话
                </button>
                
                <button onclick="testGetCount()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
                    获取会话数量
                </button>
                
                <button onclick="testGetStorageSize()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition-colors">
                    获取存储大小
                </button>
                
                <button onclick="testMigration()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                    测试数据迁移
                </button>
                
                <button onclick="testClearAll()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    清空所有会话
                </button>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">测试结果</h2>
            <div id="output" class="bg-gray-100 p-4 rounded-lg font-mono text-sm whitespace-pre-wrap min-h-[200px] max-h-[500px] overflow-auto"></div>
        </div>
    </div>

    <script src="./js/indexeddb-storage.js"></script>
    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            output.textContent = '';
        }
        
        async function testSaveSession() {
            clearOutput();
            log('开始测试保存会话...');
            
            const testSession = {
                sessionId: 'test-session-' + Date.now(),
                title: '测试会话 ' + new Date().toLocaleString(),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                workspacePath: '/test/workspace',
                toolId: 'test-tool',
                isWorkspaceValid: true,
                messages: [
                    {
                        role: 'user',
                        content: '这是一条测试消息',
                        createdAt: new Date().toISOString(),
                        cliToolId: 'test-tool',
                        isCompleted: true,
                        hasError: false
                    },
                    {
                        role: 'assistant',
                        content: '这是助手的回复',
                        createdAt: new Date().toISOString(),
                        cliToolId: 'test-tool',
                        isCompleted: true,
                        hasError: false
                    }
                ]
            };
            
            try {
                const success = await webCliIndexedDB.saveSession(testSession);
                if (success) {
                    log('✅ 会话保存成功!');
                    log(`会话ID: ${testSession.sessionId}`);
                    log(`标题: ${testSession.title}`);
                    log(`消息数量: ${testSession.messages.length}`);
                } else {
                    log('❌ 会话保存失败');
                }
            } catch (error) {
                log(`❌ 错误: ${error.message}`);
            }
        }
        
        async function testLoadSessions() {
            clearOutput();
            log('开始加载所有会话...');
            
            try {
                const sessions = await webCliIndexedDB.loadSessions();
                log(`✅ 加载成功! 共 ${sessions.length} 个会话`);
                
                sessions.forEach((session, index) => {
                    log(`\n会话 ${index + 1}:`);
                    log(`  ID: ${session.sessionId}`);
                    log(`  标题: ${session.title}`);
                    log(`  创建时间: ${new Date(session.createdAt).toLocaleString()}`);
                    log(`  更新时间: ${new Date(session.updatedAt).toLocaleString()}`);
                    log(`  消息数量: ${session.messages?.length || 0}`);
                });
            } catch (error) {
                log(`❌ 错误: ${error.message}`);
            }
        }
        
        async function testGetSession() {
            clearOutput();
            log('开始获取单个会话...');
            
            // 先获取所有会话，取第一个
            try {
                const sessions = await webCliIndexedDB.loadSessions();
                if (sessions.length === 0) {
                    log('⚠️ 没有可用的会话，请先保存一个测试会话');
                    return;
                }
                
                const sessionId = sessions[0].sessionId;
                log(`获取会话: ${sessionId}`);
                
                const session = await webCliIndexedDB.getSession(sessionId);
                if (session) {
                    log('✅ 获取成功!');
                    log(`标题: ${session.title}`);
                    log(`创建时间: ${new Date(session.createdAt).toLocaleString()}`);
                    log(`消息数量: ${session.messages?.length || 0}`);
                } else {
                    log('❌ 会话不存在');
                }
            } catch (error) {
                log(`❌ 错误: ${error.message}`);
            }
        }
        
        async function testDeleteSession() {
            clearOutput();
            log('开始删除会话...');
            
            try {
                const sessions = await webCliIndexedDB.loadSessions();
                if (sessions.length === 0) {
                    log('⚠️ 没有可用的会话');
                    return;
                }
                
                const sessionId = sessions[0].sessionId;
                log(`删除会话: ${sessionId}`);
                
                const success = await webCliIndexedDB.deleteSession(sessionId);
                if (success) {
                    log('✅ 删除成功!');
                } else {
                    log('❌ 删除失败');
                }
            } catch (error) {
                log(`❌ 错误: ${error.message}`);
            }
        }
        
        async function testGetCount() {
            clearOutput();
            log('获取会话数量...');
            
            try {
                const count = await webCliIndexedDB.getSessionCount();
                log(`✅ 当前会话数量: ${count}`);
            } catch (error) {
                log(`❌ 错误: ${error.message}`);
            }
        }
        
        async function testGetStorageSize() {
            clearOutput();
            log('获取存储大小...');
            
            try {
                const size = await webCliIndexedDB.getStorageSize();
                log(`✅ 存储使用情况:`);
                log(`  已使用: ${(size.usage / 1024 / 1024).toFixed(2)} MB`);
                log(`  总配额: ${(size.quota / 1024 / 1024).toFixed(2)} MB`);
                log(`  使用率: ${size.usagePercent}%`);
            } catch (error) {
                log(`❌ 错误: ${error.message}`);
            }
        }
        
        async function testMigration() {
            clearOutput();
            log('测试数据迁移...');
            
            // 先在 localStorage 中创建测试数据
            const testData = [
                {
                    sessionId: 'legacy-session-1',
                    title: '旧版会话 1',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    workspacePath: '/legacy/workspace',
                    toolId: 'legacy-tool',
                    isWorkspaceValid: true,
                    messages: []
                }
            ];
            
            localStorage.setItem('webcli_sessions', JSON.stringify(testData));
            log('✅ 已在 localStorage 中创建测试数据');
            
            try {
                const migrated = await webCliIndexedDB.migrateFromLocalStorage();
                if (migrated) {
                    log('✅ 数据迁移成功!');
                    log('localStorage 中的旧数据已被清理');
                } else {
                    log('ℹ️ 没有需要迁移的数据');
                }
            } catch (error) {
                log(`❌ 错误: ${error.message}`);
            }
        }
        
        async function testClearAll() {
            clearOutput();
            
            if (!confirm('确定要清空所有会话吗？此操作不可恢复！')) {
                log('操作已取消');
                return;
            }
            
            log('开始清空所有会话...');
            
            try {
                const success = await webCliIndexedDB.clearAllSessions();
                if (success) {
                    log('✅ 所有会话已清空!');
                } else {
                    log('❌ 清空失败');
                }
            } catch (error) {
                log(`❌ 错误: ${error.message}`);
            }
        }
        
        // 页面加载时显示初始信息
        window.addEventListener('load', () => {
            log('IndexedDB 测试页面已加载');
            log('请点击上方按钮进行测试');
        });
    </script>
</body>
</html>

